/* Fichier principal appelant tous les script JQuery après chargement complet du DOM.
 * 
 * @author: GAUTHIER Silvère.
 * @update: 10-04 14:01
 * @last_update_author : GAUTHIER Silvère
 */

$(document).ready(function() {
    /* Ecouteur permettant le submit du textarea via la touche "enter" (13)
     * 
     * @author: GAUTHIER Silvère.
     */
    $('textarea#form_message').keydown(function(event) {
      if (event.keyCode == 13 && $(this).val()!="") {
        this.form.submit();
        return false;
      }
      //Place automatiquement la scroll bar en bas
      scrollDown();
    });
    
    /* Ecouteur empêchant l'envoi de message vide
     * 
     * @author: GAUTHIER Silvère.
     */
    $('textarea#form_message').keyup(function(event) {
      if (event.keyCode == 13)
        if($(this).val()=='\n')
          $(this).val("");
    });
    
    //Place les écouteurs de la liste de contacts
    contact_init();
    
    //Redonne le focus par défaut à la zone de saisie
    $('textarea#form_message').focus();
    
    //Rafraîchit la zone d'affichage des messages
    refresh();
        
    //Place automatiquement la scroll bar en bas
    scrollDown();
});

/* Fonction de rafaîchissement des messages et conversations
 * 
 * @author: GAUTHIER Silvère.
 */
function refresh(id_conversation) {
  //Rafraîchissement de le zone d'affichage des messages
  if (typeof id_conversation != "undefined") { //Si le paramètre existe
    document.getElementById("form_conversation").val(id_conversation);
  } 
  else { //Si le paramètre n'existe pas, on est toujours sur la même conversation
    var id_conversation = document.getElementById("form_conversation").value;
  }
  var data_refresh = "id_conversation="+id_conversation;
  var xhr_refresh = null;
  if(window.XMLHttpRequest) 
    xhr_refresh = new XMLHttpRequest(); 
  else if(window.ActiveXObject)
    xhr_refresh = new ActiveXObject("Microsoft.XMLHTTP");
  else { 
    alert("Votre navigateur ne supporte pas les objets XMLHTTPRequest..."); 
    return; 
  }
  
  xhr_refresh.open("POST", "php/refresh.php", true);
  xhr_refresh.onreadystatechange = function() {
    if(xhr_refresh.readyState == 4) {
      //Recharge uniquement le contenu de la zone des messages
      $('div#zone_affichage').html(xhr_refresh.responseText);
      //Place automatiquement la scroll bar en bas
      scrollDown();
    }
    return xhr_refresh.readyState;
  } 
  xhr_refresh.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
  xhr_refresh.send(data_refresh);
  
  //Rafraîchissement de la liste des conversations
  data_conversation = "id_user="+document.getElementById("form_source").value;
  var xhr_conversation = null;
  if(window.XMLHttpRequest) 
    xhr_conversation = new XMLHttpRequest(); 
  else if(window.ActiveXObject)
    xhr_conversation = new ActiveXObject("Microsoft.XMLHTTP");
  else { 
    alert("Votre navigateur ne supporte pas les objets XMLHTTPRequest..."); 
    return; 
  }
  
  xhr_conversation.open("POST", "php/liste_conversations.php", true);
  xhr_conversation.onreadystatechange = function() {
    if(xhr_conversation.readyState == 4) {
      //Recharge uniquement le contenu de la liste des conversations
      $('div#liste_conversation').html(xhr_conversation.responseText);
    }
    return xhr_conversation.readyState;
  } 
  xhr_conversation.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
  xhr_conversation.send(data_conversation);
}

//Appelle refresh() toutes les 5 secondes
setInterval(refresh,5000);

/* Fonction descendant la scroll bar de la zone d'affichage en bas
 * 
 * @author: GAUTHIER Silvère.
 */
function scrollDown() {
  var element = document.getElementById('zone_affichage');
  element.scrollTop = element.scrollHeight;
}
